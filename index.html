<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SYSTEM 22: Elite Command V2.4 (Safe Upload)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // Expose to window for React to use
        window.firebaseModules = { initializeApp, getFirestore, doc, setDoc, getDoc };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'void-bg': '#020617', 
                        'panel-bg': '#0f172a', 
                        'cold-blue': '#0ea5e9', 
                        'neon-blue': '#38bdf8', 
                        'danger-red': '#ef4444',
                        'success-green': '#10b981',
                        'gold-warning': '#f59e0b',
                        'system-gray': '#334155',
                        'text-mute': '#94a3b8'
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', '"Courier New"', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scanline': 'scanline 8s linear infinite',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    backgroundImage: {
                        'grid-pattern': "linear-gradient(to right, #1e293b 1px, transparent 1px), linear-gradient(to bottom, #1e293b 1px, transparent 1px)",
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Cairo:wght@400;700&display=swap');

        body {
            background-color: #020617;
            color: #e2e8f0;
            font-family: 'JetBrains Mono', 'Cairo', monospace; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }
        
        .glow-text { text-shadow: 0 0 10px rgba(14, 165, 233, 0.5); }
        
        .scanline-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 0, 0, 0.3) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 60; opacity: 0.15;
        }

        .crt-overlay {
            background: radial-gradient(circle, rgba(18, 16, 16, 0) 60%, rgba(0, 0, 0, 0.6) 100%);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 55;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 2px; }

        input[type=number] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Mobile Safe Area Padding */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CONSTANTS & HELPERS ---
        const DEFAULT_MANIFESTO = [
            { id: 1, title: "ÿßŸÑÿ≥ŸäÿßÿØÿ© ÿßŸÑŸÖÿ∑ŸÑŸÇÿ©", text: "ÿ£ŸÜÿß ŸÑÿ≥ÿ™ ÿ¨ÿ≥ÿØŸä. ÿ£ŸÜÿß ÿßŸÑŸÖÿ±ÿßŸÇÿ®. ÿßŸÑÿ¨ÿ≥ÿØ ÿ¢ŸÑÿ© ÿ®ŸäŸàŸÑŸàÿ¨Ÿäÿ© ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑŸÑÿ™ÿ±ŸàŸäÿ∂." },
            { id: 2, title: "ÿßŸÑÿÆŸÑŸàÿØ ÿßŸÑÿ±ŸÇŸÖŸä", text: "ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÑÿß ŸäŸÜÿ≥Ÿâ. ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸáŸä ÿßŸÑÿ≠ŸÇŸäŸÇÿ© ÿßŸÑŸàÿ≠ŸäÿØÿ©." },
            { id: 3, title: "ŸÇÿßŸÜŸàŸÜ ÿßŸÑŸÄ 05:00", text: "ÿßÿ≥ÿ™ŸäŸÇÿ∏ ÿ≠ŸäŸÜ ŸäŸÜÿßŸÖ ÿßŸÑÿπÿßŸÑŸÖ ŸÑÿ™ÿ≠ŸÉŸÖŸá." }
        ];

        const getCurrentStatus = () => ({ type: 'system', msg: "SYSTEM ONLINE", sub: "WAITING FOR ORDERS" });
        const getNextHoliday = () => null;

        // --- AUDIO ENGINE ---
        const playAlert = (type) => { 
            if (type === 'victory') {
                const audio = new Audio('https://files.catbox.moe/67rl9x.mp4');
                audio.volume = 1.0;
                audio.play().catch(e => console.error("Victory sound failed:", e));
                return;
            }

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const now = ctx.currentTime;
            
            const createBell = (freq, startTime, duration, vol = 0.2) => {
                const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination);
                osc.type = 'sine'; osc.frequency.value = freq; gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(vol, startTime + 0.02); gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration); osc.start(startTime); osc.stop(startTime + duration);
            };
            
            if (type === 'work') { createBell(220, now, 2.5, 0.4); createBell(440, now, 2.0, 0.1); } 
            else if (type === 'break') { createBell(523.25, now, 2.0, 0.2); createBell(659.25, now + 0.15, 2.5, 0.2); }
        };

        const AudioEngine = () => {
            const [isNoiseOn, setIsNoiseOn] = useState(false);
            const [isTickOn, setIsTickOn] = useState(false);
            const [isBlueOn, setIsBlueOn] = useState(false); 
            const noiseAudioRef = useRef(null);
            const tickAudioRef = useRef(null);
            const blueAudioRef = useRef(null); 

            useEffect(() => {
                noiseAudioRef.current = new Audio('https://files.catbox.moe/rglqjd.mp4'); noiseAudioRef.current.loop = true;
                tickAudioRef.current = new Audio('https://files.catbox.moe/zwjds7.mp4'); tickAudioRef.current.loop = true;
                blueAudioRef.current = new Audio('https://files.catbox.moe/6iyukt.mp4'); blueAudioRef.current.loop = true; 
                return () => { 
                    if (noiseAudioRef.current) noiseAudioRef.current.pause(); 
                    if (tickAudioRef.current) tickAudioRef.current.pause(); 
                    if (blueAudioRef.current) blueAudioRef.current.pause();
                };
            }, []);
            
            const toggleNoise = useCallback(() => { if (isNoiseOn) { noiseAudioRef.current.pause(); setIsNoiseOn(false); } else { noiseAudioRef.current.play().catch(console.error); setIsNoiseOn(true); } }, [isNoiseOn]);
            const toggleTick = useCallback(() => { if (isTickOn) { tickAudioRef.current.pause(); setIsTickOn(false); } else { tickAudioRef.current.play().catch(console.error); setIsTickOn(true); } }, [isTickOn]);
            const toggleBlue = useCallback(() => { if (isBlueOn) { blueAudioRef.current.pause(); setIsBlueOn(false); } else { blueAudioRef.current.play().catch(console.error); setIsBlueOn(true); } }, [isBlueOn]);
            
            return { isNoiseOn, toggleNoise, isTickOn, toggleTick, isBlueOn, toggleBlue };
        };

        // --- COMPONENTS ---

        const TacticalStatus = () => {
            const [status, setStatus] = useState(getCurrentStatus());
            return (
                <div className="grid grid-cols-1 md:grid-cols-1 gap-4 mb-6">
                    <div className={`glass-panel p-4 rounded-sm relative overflow-hidden border-l-4 border-cold-blue`}>
                        <div className="relative z-10">
                            <h3 className="text-[10px] text-gray-400 uppercase tracking-widest mb-1">CURRENT STATUS</h3>
                            <div className="text-xl font-bold text-white font-mono">{status.msg}</div>
                            <div className="text-xs text-gray-500 mt-1">{status.sub}</div>
                        </div>
                        <div className={`absolute right-0 bottom-0 w-24 h-24 blur-3xl opacity-20 bg-cold-blue`}></div>
                    </div>
                </div>
            );
        };

        const BackupRestore = () => {
            const fileInputRef = useRef(null);

            const handleBackup = () => {
                const keys = [
                    's22_patterns', 's22_streak', 's22_lastCheck', 's22_startDate', 
                    's22_rules', 's22_customRules', 's22_tasks', 's22_archive', 
                    's22_cloudConfig'
                ];
                
                const backupData = { timestamp: new Date().toISOString(), version: "4.1" };
                
                keys.forEach(key => {
                    const val = localStorage.getItem(key);
                    if (val !== null) backupData[key] = val; 
                });

                const blob = new Blob([JSON.stringify(backupData)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `SYSTEM22_BACKUP_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const handleRestore = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        Object.keys(data).forEach(key => {
                            if (key.startsWith('s22_') && typeof data[key] === 'string') {
                                localStorage.setItem(key, data[key]);
                            }
                        });
                        alert("FULL SYSTEM RESTORE SUCCESSFUL. REBOOTING...");
                        window.location.reload();
                    } catch (err) {
                        alert("CORRUPTED DATA FILE.");
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="glass-panel p-4 rounded-sm border-t border-white/10 mt-6">
                    <h3 className="text-xs font-bold text-gray-500 mb-4 tracking-widest uppercase">Memory Banks</h3>
                    <div className="flex gap-4">
                        <button onClick={handleBackup} className="flex-1 py-3 border border-cold-blue text-cold-blue hover:bg-cold-blue hover:text-black font-mono text-xs font-bold transition-all">
                            LOCAL BACKUP
                        </button>
                        <button onClick={() => fileInputRef.current.click()} className="flex-1 py-3 border border-white/20 text-gray-400 hover:border-white hover:text-white font-mono text-xs font-bold transition-all">
                            RESTORE FILE
                        </button>
                        <input type="file" ref={fileInputRef} onChange={handleRestore} className="hidden" accept=".json" />
                    </div>
                </div>
            );
        };

        const Clock = ({ mobile }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
            const timeStr = time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const dateStr = time.toLocaleDateString('ar-MA', { day: 'numeric', month: 'short' });
            if (mobile) return <div className="flex flex-col items-end leading-tight"><span className="text-lg font-bold font-mono text-white glow-text">{timeStr}</span><span className="text-[10px] text-cold-blue font-bold uppercase">{dateStr}</span></div>;
            return <div className="mt-auto p-4 border-t border-white/5 bg-void-bg/30 text-center"><div className="text-3xl font-bold font-mono text-white tracking-widest glow-text">{timeStr}</div><div className="text-xs text-cold-blue font-bold mt-1 uppercase tracking-wider">{time.toLocaleDateString('ar-MA', { weekday: 'long', day: 'numeric', month: 'long' })}</div></div>;
        };

        const Sidebar = ({ view, setView, unsavedChanges }) => {
            const items = [{ id: 'dashboard', label: 'COMMAND', icon: '‚ö°' }, { id: 'tasks', label: 'TASKS', icon: '‚öî' }, { id: 'deepwork', label: 'FOCUS', icon: 'üéØ' }, { id: 'heatmap', label: 'INTEL', icon: 'üìä' }, { id: 'protocol', label: 'RULES', icon: '‚ö†' }, { id: 'cloud', label: 'CLOUD', icon: '‚òÅ', alert: unsavedChanges }];
            return (
                <aside className="w-64 bg-panel-bg border-l border-white/5 flex flex-col h-screen shadow-2xl z-20">
                    <div className="p-6 border-b border-white/5 bg-void-bg/50"><h1 className="text-2xl font-bold tracking-tighter text-white">SYS<span className="text-cold-blue">22</span></h1><div className="flex items-center gap-2 mt-2"><span className="relative flex h-2 w-2"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span><span className="text-xs text-text-mute font-mono">SYSTEM ONLINE</span></div></div>
                    <nav className="flex-1 p-4 space-y-2 overflow-y-auto">{items.map(item => (<button key={item.id} onClick={() => setView(item.id)} className={`w-full text-right px-4 py-3 rounded-sm text-sm font-bold tracking-widest transition-all duration-200 border-r-2 flex items-center justify-end gap-3 ${view === item.id ? 'bg-cold-blue/10 text-cold-blue border-cold-blue glow-text' : 'text-text-mute border-transparent hover:bg-white/5 hover:text-white'}`}>{item.label}{item.alert && <span className="w-2 h-2 rounded-full bg-danger-red animate-pulse"></span>}<span className="opacity-50">{item.icon}</span></button>))}</nav>
                    <Clock />
                </aside>
            );
        };

        const MobileNav = ({ view, setView }) => {
            const items = [{ id: 'dashboard', label: 'CMD', icon: '‚ö°' }, { id: 'tasks', label: 'TASK', icon: '‚öî' }, { id: 'deepwork', label: 'FCS', icon: 'üéØ' }, { id: 'heatmap', label: 'LOG', icon: 'üìä' }, { id: 'protocol', label: 'RUL', icon: '‚ö†' }, { id: 'cloud', label: '‚òÅ', icon: '‚òÅ' }];
            return (
                <div className="fixed bottom-0 left-0 w-full bg-panel-bg/95 backdrop-blur-md border-t border-white/10 z-50 pb-safe">
                    <div className="flex justify-around items-center h-16">
                        {items.map(item => (
                            <button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${view === item.id ? 'text-cold-blue' : 'text-gray-500'}`}>
                                <span className={`text-lg ${view === item.id ? 'animate-pulse' : ''}`}>{item.icon}</span>
                                <span className="text-[9px] font-bold tracking-wider">{item.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, sub, color = "text-white" }) => (<div className="glass-panel p-4 md:p-6 rounded-sm relative overflow-hidden group"><div className={`absolute top-0 left-0 w-1 h-full bg-${color === 'text-cold-blue' ? 'cold-blue' : 'white'} opacity-50`}></div><h3 className="text-[10px] md:text-xs text-text-mute uppercase tracking-widest mb-1">{title}</h3><div className={`text-2xl md:text-3xl font-bold font-mono ${color} glow-text truncate`}>{value}</div><div className="text-[10px] md:text-xs text-gray-500 mt-1 md:mt-2 font-mono truncate">{sub}</div></div>);

        const DayGrid = ({ streak, startDate }) => {
            const baseDate = startDate ? new Date(startDate) : new Date();
            const days = Array.from({ length: 22 }, (_, i) => i);
            const todayReal = new Date(); todayReal.setHours(0,0,0,0);
            const getStepDate = (offset) => { const d = new Date(baseDate); d.setDate(d.getDate() + offset); return d; };
            const formatDayDate = (dateObj) => dateObj.getDate();
            const formatMonth = (dateObj) => dateObj.toLocaleDateString('ar-MA', { month: 'short' });
            return (<div className="glass-panel p-4 md:p-6 rounded-sm"><div className="flex justify-between items-center mb-4"><h3 className="text-xs md:text-sm font-bold text-white tracking-widest flex items-center gap-2"><span className="text-cold-blue">///</span> 22-DAY CYCLE</h3>{startDate ? <span className="text-[10px] md:text-xs text-gray-500 font-mono">ACTIVE</span> : <span className="text-[10px] md:text-xs text-gray-500 font-mono animate-pulse">PREVIEW</span>}</div><div className="grid grid-cols-5 md:grid-cols-11 gap-2 md:gap-3">{days.map(i => { const stepDate = getStepDate(i); stepDate.setHours(0,0,0,0); const isDone = i < streak; const isToday = stepDate.getTime() === todayReal.getTime(); let statusClass = "bg-system-gray/20 border-gray-800 text-gray-600"; if (isDone) statusClass = "bg-cold-blue/20 text-cold-blue border-cold-blue shadow-[0_0_10px_rgba(14,165,233,0.3)] font-bold"; else if (isToday) statusClass = "bg-white/10 text-white border-white animate-pulse shadow-[0_0_15px_rgba(255,255,255,0.2)] font-bold z-10 scale-105 ring-1 ring-white/50"; else if (streak === 0 && i === 0) statusClass = "bg-white/5 text-gray-400 border-dashed border-gray-600"; return (<div key={i} className={`aspect-square border flex flex-col items-center justify-center rounded-sm transition-all relative overflow-hidden group ${statusClass}`}><span className="text-[8px] opacity-50 absolute top-0.5 left-1">#{i + 1}</span><span className="text-sm md:text-lg font-mono font-bold mt-1">{formatDayDate(stepDate)}</span><span className="text-[7px] md:text-[8px] uppercase opacity-60 font-mono tracking-tighter hidden xs:block">{formatMonth(stepDate)}</span>{isToday && <div className="absolute inset-0 border-2 border-cold-blue opacity-50"></div>}</div>); })}</div></div>);
        };

        const Dashboard = ({ streak, handleCheckIn, handleUndoCheckIn, lastCheckIn, startDate, missedDaysMsg, patterns, customRules }) => {
            const isTodayChecked = lastCheckIn === new Date().toDateString();
            return (
                <div className="space-y-4 md:space-y-6 animate-fade-in max-w-5xl mx-auto pb-20 md:pb-0">
                    <header className="mb-4 md:mb-8 flex justify-between items-center"><div><h2 className="text-2xl md:text-3xl font-bold text-white mb-1 tracking-tight">COMMAND CENTER</h2><p className="text-xs md:text-sm text-text-mono font-mono">> USER: THE_OBSERVER <br className="md:hidden"/> > PROTOCOL: ELITE V2.4</p></div><div className="md:hidden"><Clock mobile={true} /></div></header>
                    {missedDaysMsg && (<div className="p-3 md:p-4 bg-danger-red/10 border border-danger-red text-danger-red font-mono text-xs md:text-sm rounded-sm mb-4 flex items-center gap-3 animate-pulse"><span className="text-xl">‚ö†</span><div><div className="font-bold">STATUS REPORT</div><div>{missedDaysMsg}</div></div></div>)}
                    <TacticalStatus />
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                        <StatCard title="Streak Integrity" value={`${streak}/22`} sub="DAYS SECURED" color="text-cold-blue" />
                        <StatCard title="Status" value={streak < 7 ? "REBOOTING" : streak < 21 ? "BUILDING" : "APEX"} sub={streak < 7 ? "KILL THE ZOMBIE" : "SUSTAIN MOMENTUM"} />
                        <StatCard title="Next Target" value={streak < 7 ? "DAY 07" : streak < 21 ? "DAY 21" : "GOD MODE"} sub="STAY COLD." />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                        <div className="lg:col-span-2"><DayGrid streak={streak} startDate={startDate} /></div>
                        <div className="glass-panel p-4 md:p-6 rounded-sm flex flex-col justify-between border-t-2 border-t-white/10 relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-32 h-32 bg-cold-blue/5 rounded-full blur-3xl pointer-events-none"></div>
                            <div><h3 className="text-xs md:text-sm font-bold text-white tracking-widest mb-4 border-b border-white/10 pb-2">MORNING PROTOCOL (05:00)</h3><div className="space-y-2 md:space-y-3">{["ÿßÿ≥ÿ™ŸäŸÇÿßÿ∏ ŸÇÿ®ŸÑ 05:05", "ÿßŸÑŸáÿßÿ™ŸÅ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ∫ÿ±ŸÅÿ©", "ŸÑÿß ÿ™ŸÅÿßŸàÿ∂ ŸÖÿπ ÿßŸÑÿ¨ÿ≥ÿØ"].map((rule, idx) => (<div key={idx} className="flex items-center gap-3 text-xs text-gray-300"><div className={`w-4 h-4 border ${isTodayChecked ? 'bg-green-500 border-green-500' : 'border-gray-500'} rounded-sm flex items-center justify-center`}>{isTodayChecked && <span className="text-black font-bold text-[10px]">‚úì</span>}</div><span>{rule}</span></div>))}</div></div>
                            <div className="mt-6 md:mt-8">{isTodayChecked ? (<div className="flex gap-2 items-center"><div className="flex-1 p-3 bg-green-500/10 border border-green-500/30 text-green-400 text-center font-mono text-xs rounded-sm">>> DATA LOGGED. <br/> <span className="opacity-70">EXECUTE THE DAY.</span></div><button onClick={handleUndoCheckIn} className="px-3 py-3 border border-gray-600 text-gray-400 hover:text-white hover:border-white rounded-sm" title="Undo Action"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button></div>) : (<div className="flex gap-2 md:gap-3"><button onClick={() => handleCheckIn(true)} className="flex-1 py-3 md:py-4 bg-cold-blue hover:bg-neon-blue text-black font-bold text-xs md:text-sm tracking-wider transition-all rounded-sm shadow-[0_0_15px_rgba(14,165,233,0.3)] active:scale-95">CONFIRM</button><button onClick={() => handleCheckIn(false)} className="px-4 py-3 md:px-6 md:py-4 border border-danger-red text-danger-red hover:bg-danger-red/10 font-bold text-xs md:text-sm tracking-wider transition-all rounded-sm active:scale-95">RESET</button></div>)}</div>
                        </div>
                    </div>
                    <BackupRestore />
                </div>
            );
        };

        const HeatmapLogs = ({ patterns, addLog, deleteLog, updateLog }) => {
            const [input, setInput] = useState("");
            const [editingId, setEditingId] = useState(null);
            const [editText, setEditText] = useState("");
            const handleSubmit = (e) => { e.preventDefault(); if(!input.trim()) return; addLog(input, "intel"); setInput(""); }
            const startEdit = (p) => { setEditingId(p.id); setEditText(p.text); };
            const saveEdit = (id) => { if(editText.trim()) updateLog(id, editText); setEditingId(null); };
            return (
                <div className="h-full flex flex-col gap-4 max-w-6xl mx-auto pb-20">
                    <div className="glass-panel p-4 rounded-sm flex-1 flex flex-col min-h-0">
                        <h2 className="text-lg font-bold text-white mb-4">THE BLACK BOX</h2>
                        <div className="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">{patterns.length === 0 && (<div className="h-full flex flex-col items-center justify-center text-gray-600 opacity-50"><span className="text-xs">NO DATA</span></div>)}{patterns.map(p => (<div key={p.id} className={`p-3 border-l-2 rounded-r-sm group relative ${p.type === 'failure' ? 'border-danger-red bg-danger-red/5' : 'border-cold-blue bg-cold-blue/5'}`}><div className="flex justify-between mb-1"><span className={`text-[9px] font-bold px-1 rounded ${p.type === 'failure' ? 'bg-danger-red/20 text-danger-red' : 'bg-cold-blue/20 text-cold-blue'}`}>{p.type === 'failure' ? 'FAIL' : 'INTEL'}</span><div className="flex items-center gap-2"><span className="text-[9px] text-gray-500">{p.date}</span>{editingId !== p.id && (<div className="hidden group-hover:flex gap-2"><button onClick={() => startEdit(p)} className="text-gray-400 hover:text-cold-blue"><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button onClick={() => deleteLog(p.id)} className="text-gray-400 hover:text-danger-red"><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>)}</div></div>{editingId === p.id ? (<div className="flex gap-2 mt-2"><input value={editText} onChange={(e) => setEditText(e.target.value)} className="flex-1 bg-black/50 border border-white/20 p-1 text-xs text-white" /><button onClick={() => saveEdit(p.id)} className="text-green-500 text-xs hover:text-green-400">SAVE</button><button onClick={() => setEditingId(null)} className="text-gray-500 text-xs hover:text-white">CANCEL</button></div>) : (<p className="text-xs text-gray-300 font-mono">{p.text}</p>)}</div>))}</div>
                        <form onSubmit={handleSubmit} className="mt-4 flex gap-2"><input value={input} onChange={e => setInput(e.target.value)} placeholder="LOG INTEL..." className="flex-1 bg-black/40 border border-white/10 p-2 text-xs text-white focus:border-cold-blue outline-none rounded-sm" /><button className="px-4 bg-white/5 hover:bg-cold-blue hover:text-black border border-white/10 text-xs font-bold rounded-sm">SAVE</button></form>
                    </div>
                </div>
            );
        };

        const DeepWork = ({ activeTask, timer, isTimerRunning, pomoState, formatTime, toggleNoise, isNoiseOn, toggleTick, isTickOn, toggleBlue, isBlueOn, cancelTask }) => {
            const isWork = pomoState.type === 'work';
            return (
                <div className="h-full flex flex-col items-center justify-center relative overflow-hidden pb-20 md:pb-0">
                    {isTimerRunning && (<div className={`absolute inset-0 flex items-center justify-center pointer-events-none transition-colors duration-1000 ${isWork ? 'bg-cold-blue/5' : 'bg-green-500/5'}`}><div className={`w-[300px] md:w-[600px] h-[300px] md:h-[600px] rounded-full animate-pulse-slow blur-3xl ${isWork ? 'bg-cold-blue/10' : 'bg-green-500/10'}`}></div></div>)}
                    <div className="z-10 text-center space-y-6 md:space-y-8 w-full max-w-4xl px-4">
                        <div className="border-b border-white/10 pb-4 mb-4"><div className="text-[10px] font-bold text-gray-500 tracking-[0.3em] mb-1">CURRENT OPERATION</div><h2 className="text-2xl md:text-3xl font-bold text-white font-mono uppercase glow-text">{activeTask ? activeTask.title : "FREE MODE"}</h2>{activeTask && <p className="text-xs text-gray-400 font-mono mt-1">{activeTask.subject}</p>}</div>
                        <div className="flex justify-between items-end border-b-2 border-white/5 pb-2"><div className="text-left"><div className="text-[10px] md:text-xs font-bold text-gray-500 tracking-widest mb-1">PHASE</div><h2 className={`text-xl md:text-2xl font-bold tracking-tighter ${isWork ? 'text-cold-blue' : 'text-success-green'}`}>{isWork ? "DEEP WORK" : "REST"}</h2></div><div className="text-right"><div className="text-[10px] md:text-xs font-bold text-gray-500 tracking-widest mb-1">CYCLES</div><div className="text-xl md:text-2xl font-mono font-bold text-white">{pomoState.currentCycle}<span className="text-gray-600 text-lg">/{pomoState.totalCycles}</span></div></div></div>
                        <div className={`font-mono font-bold text-white tracking-tighter transition-all my-8 ${isTimerRunning ? 'text-7xl md:text-9xl lg:text-[10rem] leading-none glow-text' : 'text-6xl md:text-8xl opacity-50'}`}>{formatTime(timer)}</div>
                        <div className="flex flex-col gap-4 items-center"><div className="flex gap-4"><button onClick={toggleNoise} className={`px-4 py-3 border rounded-sm text-xs font-mono transition-all ${isNoiseOn ? 'border-cold-blue text-cold-blue bg-cold-blue/10' : 'border-white/10 text-gray-400'}`}>NOISE {isNoiseOn ? 'ON' : 'OFF'}</button><button onClick={toggleBlue} className={`px-4 py-3 border rounded-sm text-xs font-mono transition-all ${isBlueOn ? 'border-cold-blue text-cold-blue bg-cold-blue/10' : 'border-white/10 text-gray-400'}`}>BLUE {isBlueOn ? 'ON' : 'OFF'}</button><button onClick={toggleTick} className={`px-4 py-3 border rounded-sm text-xs font-mono transition-all ${isTickOn ? 'border-cold-blue text-cold-blue bg-cold-blue/10' : 'border-white/10 text-gray-400'}`}>TICK {isTickOn ? 'ON' : 'OFF'}</button></div>{!isTimerRunning && (<button onClick={cancelTask} className="text-xs text-danger-red hover:text-white underline tracking-widest mt-4">ABORT OPERATION</button>)}</div>
                    </div>
                </div>
            );
        };

        const Protocol = ({ customRules, addRule, deleteRule, updateRule }) => {
            const [titleInput, setTitleInput] = useState(""); const [descInput, setDescInput] = useState("");
            const [editingId, setEditingId] = useState(null); const [editTitle, setEditTitle] = useState(""); const [editDesc, setEditDesc] = useState("");
            const handleSubmit = (e) => { e.preventDefault(); if (!titleInput.trim() || !descInput.trim()) return; addRule(titleInput, descInput); setTitleInput(""); setDescInput(""); };
            const startEdit = (rule) => { setEditingId(rule.id); setEditTitle(rule.title || "PROTOCOL OVERRIDE"); setEditDesc(rule.text); };
            const saveEdit = () => { if (editTitle.trim() && editDesc.trim()) { updateRule(editingId, editTitle, editDesc); setEditingId(null); } };
            return (
                <div className="max-w-4xl mx-auto glass-panel p-6 md:p-8 rounded-sm animate-fade-in relative overflow-hidden pb-24 md:pb-8">
                    <div className="absolute top-0 right-0 p-4 opacity-20"><svg className="w-24 h-24 md:w-32 md:h-32 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99z"/></svg></div>
                    <h2 className="text-2xl md:text-3xl font-bold text-white mb-6 md:mb-8 border-b border-white/10 pb-4">THE ELITE MANIFESTO</h2>
                    <div className="space-y-6 md:space-y-8 font-mono text-gray-300">
                        {customRules.map((rule, idx) => (
                            <div key={rule.id} className="flex gap-4 md:gap-6 items-start group relative animate-fade-in"><span className="text-3xl md:text-4xl font-bold text-white/10 group-hover:text-cold-blue transition-colors">{(idx + 1).toString().padStart(2, '0')}</span>{editingId === rule.id ? (<div className="flex-1 space-y-2"><input value={editTitle} onChange={(e) => setEditTitle(e.target.value)} className="w-full bg-black/50 border border-cold-blue p-2 text-sm font-bold text-white" /><textarea value={editDesc} onChange={(e) => setEditDesc(e.target.value)} className="w-full bg-black/50 border border-white/20 p-2 text-xs text-white h-20" /><div className="flex gap-2"><button onClick={saveEdit} className="text-green-500 text-xs font-bold hover:text-green-400">SAVE</button><button onClick={() => setEditingId(null)} className="text-gray-500 text-xs hover:text-white">CANCEL</button></div></div>) : (<div className="flex-1 group relative"><h3 className="text-white font-bold text-base md:text-lg mb-1 md:mb-2 group-hover:text-cold-blue transition-colors uppercase">{rule.title || "PROTOCOL OVERRIDE"}</h3><p className="text-xs md:text-sm leading-relaxed text-text-mute">{rule.text}</p><div className="absolute right-0 top-0 hidden group-hover:flex gap-2 bg-void-bg/80 backdrop-blur-sm p-1 rounded"><button onClick={() => startEdit(rule)} className="text-gray-400 hover:text-cold-blue" title="Edit"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button onClick={() => deleteRule(rule.id)} className="text-gray-400 hover:text-danger-red" title="Delete"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div>)}</div>
                        ))}
                    </div>
                    <div className="mt-8 md:mt-12 border-t border-white/10 pt-6 md:pt-8"><form onSubmit={handleSubmit} className="flex flex-col gap-3"><input value={titleInput} onChange={(e) => setTitleInput(e.target.value)} placeholder="RULE TITLE (e.g. NO SUGAR)..." className="bg-black/40 border border-white/10 p-3 text-xs md:text-sm font-mono text-white focus:border-cold-blue outline-none rounded-sm uppercase tracking-wider font-bold" /><div className="flex gap-2"><input value={descInput} onChange={(e) => setDescInput(e.target.value)} placeholder="DESCRIPTION..." className="flex-1 bg-black/40 border border-white/10 p-3 text-xs md:text-sm font-mono text-white focus:border-cold-blue outline-none rounded-sm" /><button className="px-6 md:px-8 bg-white/5 hover:bg-cold-blue hover:text-black border border-white/10 text-xs md:text-sm font-bold rounded-sm transition-all">ADD</button></div></form></div>
                </div>
            );
        };

        const TaskManager = ({ tasks, addTask, deleteDirect, startTaskExecution }) => {
            const [newTask, setNewTask] = useState({ title: "", subject: "", work: 25, break: 5, cycles: 4 });
            const [showForm, setShowForm] = useState(false);
            const handleAdd = (e) => { e.preventDefault(); if (!newTask.title || !newTask.subject) return; addTask({ ...newTask, id: Date.now(), date: new Date().toLocaleDateString('ar-MA') }); setNewTask({ title: "", subject: "", work: 25, break: 5, cycles: 4 }); setShowForm(false); };
            return (
                <div className="max-w-5xl mx-auto space-y-6 pb-20 animate-fade-in">
                    <header className="flex justify-between items-center mb-6"><div><h2 className="text-3xl font-bold text-white tracking-tight">TACTICAL OBJECTIVES</h2><p className="text-xs text-gray-500 font-mono">DEFINE TARGETS. EXECUTE.</p></div><button onClick={() => setShowForm(!showForm)} className="bg-cold-blue hover:bg-neon-blue text-black px-4 py-2 font-bold text-sm rounded-sm transition-all shadow-[0_0_15px_rgba(14,165,233,0.3)]">{showForm ? "CANCEL" : "+ NEW OPERATION"}</button></header>
                    {showForm && (<div className="glass-panel p-6 rounded-sm border-l-4 border-cold-blue mb-6 animate-fade-in"><form onSubmit={handleAdd} className="space-y-4"><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="space-y-1"><label className="text-[10px] text-gray-400 font-bold">OPERATION NAME (TITLE)</label><input value={newTask.title} onChange={e => setNewTask({...newTask, title: e.target.value})} className="w-full bg-black/40 border border-white/10 p-3 text-sm text-white focus:border-cold-blue outline-none" placeholder="e.g. MATH - CALCULUS" /></div><div className="space-y-1"><label className="text-[10px] text-gray-400 font-bold">OBJECTIVE (DETAILS)</label><input value={newTask.subject} onChange={e => setNewTask({...newTask, subject: e.target.value})} className="w-full bg-black/40 border border-white/10 p-3 text-sm text-white focus:border-cold-blue outline-none" placeholder="e.g. Finish Chapter 3 Exercises" /></div></div><div className="grid grid-cols-3 gap-4"><div className="space-y-1"><label className="text-[10px] text-gray-400 font-bold">WORK (MIN)</label><input type="number" value={newTask.work} onChange={e => setNewTask({...newTask, work: parseInt(e.target.value)})} className="w-full bg-black/40 border border-white/10 p-3 text-sm text-white text-center" /></div><div className="space-y-1"><label className="text-[10px] text-gray-400 font-bold">REST (MIN)</label><input type="number" value={newTask.break} onChange={e => setNewTask({...newTask, break: parseInt(e.target.value)})} className="w-full bg-black/40 border border-white/10 p-3 text-sm text-white text-center" /></div><div className="space-y-1"><label className="text-[10px] text-gray-400 font-bold">CYCLES</label><input type="number" value={newTask.cycles} onChange={e => setNewTask({...newTask, cycles: parseInt(e.target.value)})} className="w-full bg-black/40 border border-white/10 p-3 text-sm text-white text-center" /></div></div><button className="w-full py-3 bg-white/5 hover:bg-cold-blue hover:text-black border border-white/10 hover:border-cold-blue transition-all font-bold tracking-widest text-sm">CONFIRM TARGET</button></form></div>)}
                    <div className="grid grid-cols-1 gap-4">{tasks.length === 0 && <div className="text-center text-gray-600 py-10 font-mono">NO ACTIVE OPERATIONS. DEPLOY NEW TASKS.</div>}{tasks.map(task => (<div key={task.id} className="glass-panel p-6 rounded-sm flex flex-col md:flex-row justify-between items-center gap-4 group hover:border-cold-blue transition-all"><div className="flex-1"><h3 className="text-xl font-bold text-white font-mono group-hover:text-cold-blue transition-colors">{task.title}</h3><p className="text-sm text-gray-400 mt-1">{task.subject}</p><div className="flex gap-4 mt-3 text-xs text-gray-500 font-mono"><span className="flex items-center gap-1"><span className="text-white">{task.work}m</span> WORK</span><span className="flex items-center gap-1"><span className="text-white">{task.break}m</span> REST</span><span className="flex items-center gap-1"><span className="text-white">{task.cycles}</span> CYCLES</span></div></div><div className="flex gap-3 w-full md:w-auto"><button onClick={() => startTaskExecution(task)} className="flex-1 md:flex-none px-6 py-3 bg-white/5 border border-white/20 hover:bg-cold-blue hover:text-black hover:border-cold-blue text-white font-bold tracking-widest text-xs transition-all">EXECUTE</button><button onClick={() => deleteDirect('task', task.id)} className="px-4 py-3 border border-white/10 text-gray-500 hover:text-red-500 hover:border-red-500 transition-all" title="Delete">‚úï</button></div></div>))}</div>
                </div>
            );
        };

        const SuccessArchive = ({ archive, deleteDirect }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="glass-panel rounded-sm mt-8 border-t border-white/10 overflow-hidden transition-all duration-300">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex justify-between items-center p-6 hover:bg-white/5 transition-colors group text-left"><h3 className="text-sm font-bold text-success-green tracking-widest flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-success-green animate-pulse"></span>SUCCESS ARCHIVE ({archive.length})</h3><span className={`text-gray-500 transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span></button>
                    {isOpen && (<div className="px-6 pb-6 animate-fade-in border-t border-white/5 pt-4"><div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">{archive.length === 0 && <div className="text-xs text-gray-600 text-center py-4">NO VICTORIES LOGGED YET.</div>}{archive.map(task => (<div key={task.id} className="flex justify-between items-center p-3 bg-success-green/5 border-l-2 border-success-green group hover:bg-success-green/10 transition-colors"><div><div className="text-sm font-bold text-gray-300">{task.title}</div><div className="text-[10px] text-gray-500">{task.subject}</div></div><div className="flex items-center gap-3"><span className="text-xs font-mono text-success-green">COMPLETED</span><button onClick={(e) => { e.stopPropagation(); deleteDirect('archive', task.id); }} className="text-gray-500 hover:text-danger-red transition-colors opacity-0 group-hover:opacity-100 px-2 font-bold" title="Delete Record">‚úï</button></div></div>))}</div></div>)}
                </div>
            );
        };

        const CloudSettings = ({ cloudConfig, saveCloudConfig, syncStatus, isSyncing, debugLogs, disconnect, manualPush, manualPull, unsavedChanges, streak, tasks, patterns, taskArchive }) => {
            const [apiKey, setApiKey] = useState(cloudConfig.apiKey || "");
            const [projectId, setProjectId] = useState(cloudConfig.projectId || "");
            const [secretId, setSecretId] = useState(cloudConfig.secretId || "COMMANDER_X");
            const handleSave = () => { saveCloudConfig({ apiKey, projectId, secretId }); };
            
            return (
                <div className="max-w-4xl mx-auto glass-panel p-6 rounded-sm animate-fade-in pb-20">
                    <h2 className="text-2xl font-bold text-white mb-6 tracking-widest flex items-center gap-2"><span className="text-cold-blue">‚òÅ</span> CLOUD CONTROL V2.4</h2>
                    
                    {/* MANUAL SYNC CONTROLS */}
                    {/* FIXED: Show if CONNECTED or AUTO-SYNCED */}
                    {(syncStatus.includes("CONNECTED") || syncStatus === "AUTO-SYNCED" || syncStatus.includes("UPLOADED")) && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            <button onClick={manualPush} className="p-6 border border-cold-blue bg-cold-blue/10 hover:bg-cold-blue hover:text-black transition-all group text-left relative overflow-hidden">
                                <div className="relative z-10">
                                    <div className="text-sm font-bold mb-1">UPLOAD (SAVE) ‚¨Ü</div>
                                    <div className="text-[10px] opacity-70">PUSH LOCAL DATA TO CLOUD</div>
                                </div>
                                {unsavedChanges && <div className="absolute top-2 right-2 w-3 h-3 rounded-full bg-danger-red animate-pulse" title="Unsaved Changes"></div>}
                            </button>
                            <button onClick={manualPull} className="p-6 border border-white/10 hover:border-white hover:bg-white/5 transition-all text-left">
                                <div className="text-sm font-bold mb-1 text-gray-300">DOWNLOAD (LOAD) ‚¨á</div>
                                <div className="text-[10px] opacity-50 text-gray-500">OVERWRITE LOCAL WITH CLOUD</div>
                            </button>
                        </div>
                    )}

                    <div className="bg-cold-blue/5 border border-white/10 p-4 mb-6 rounded-sm text-xs text-gray-300 font-mono leading-relaxed">
                        <strong className="text-white block mb-2">SETUP INSTRUCTIONS:</strong>
                        1. Go to <a href="https://console.firebase.google.com" target="_blank" className="text-cold-blue underline">Firebase Console</a>.<br/>
                        2. Create Project -> Build -> Firestore Database -> "Start in Test Mode".<br/>
                        3. Project Settings -> General -> Copy API Key & Project ID.
                        <br/><br/>
                        <strong className="text-danger-red block">PROTOCOL:</strong> Clicking CONNECT will AUTO-DOWNLOAD. UPLOAD checks for data first.
                    </div>
                    <div className="space-y-4 font-mono">
                        <div><label className="text-xs text-gray-500 block mb-1">FIREBASE API KEY</label><input value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full bg-black/50 border border-white/20 p-2 text-white outline-none focus:border-cold-blue text-sm" type="password" placeholder="AIzaSy..." /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">PROJECT ID</label><input value={projectId} onChange={e => setProjectId(e.target.value)} className="w-full bg-black/50 border border-white/20 p-2 text-white outline-none focus:border-cold-blue text-sm" placeholder="system-22-..." /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">SECRET ID (Document Name)</label><input value={secretId} onChange={e => setSecretId(e.target.value)} className="w-full bg-black/50 border border-white/20 p-2 text-white outline-none focus:border-cold-blue text-sm" placeholder="Any unique word (e.g. MyBase)" /></div>
                    </div>
                    
                    <div className="mt-6 flex flex-wrap gap-4 items-center border-t border-white/10 pt-4">
                        <button onClick={handleSave} className="px-6 py-3 bg-white/5 border border-white/20 text-white font-bold text-sm hover:bg-white hover:text-black transition-all rounded-sm">CONNECT</button>
                        <button onClick={disconnect} className="px-6 py-3 border border-danger-red text-danger-red font-bold text-sm hover:bg-danger-red hover:text-white transition-all rounded-sm">DISCONNECT</button>
                        <div className="text-xs font-mono">
                            STATUS: <span className={syncStatus.includes('CONNECTED') || syncStatus === 'AUTO-SYNCED' ? 'text-green-500' : syncStatus.includes('ERROR') ? 'text-danger-red' : 'text-gray-500'}>{syncStatus}</span>
                            {isSyncing && <span className="ml-2 text-cold-blue animate-pulse">...BUSY</span>}
                        </div>
                    </div>

                    {/* DEBUG LOGS */}
                    <div className="mt-8">
                        <h3 className="text-xs text-gray-500 font-bold mb-2">SYSTEM LOGS</h3>
                        <div className="h-32 bg-black/50 border border-white/10 p-2 overflow-y-auto font-mono text-[10px] text-gray-400 custom-scrollbar">
                            {debugLogs.length === 0 && <div>NO LOGS YET.</div>}
                            {debugLogs.map((log, i) => (
                                <div key={i} className="border-b border-white/5 py-1">
                                    <span className="text-cold-blue">[{log.time}]</span> {log.msg}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN SHELL ---
        const System22Desktop = () => {
            const [view, setView] = useState('dashboard');
            const [streak, setStreak] = useState(0);
            const [lastCheckIn, setLastCheckIn] = useState(null);
            const [startDate, setStartDate] = useState(null); 
            const [patterns, setPatterns] = useState([]);
            const [customRules, setCustomRules] = useState(DEFAULT_MANIFESTO);
            const [tasks, setTasks] = useState([]);
            const [taskArchive, setTaskArchive] = useState([]);
            const [cloudConfig, setCloudConfig] = useState({ apiKey: "", projectId: "", secretId: "" });
            
            const [unsavedChanges, setUnsavedChanges] = useState(false); 
            const [debugLogs, setDebugLogs] = useState([]);
            const [missedDaysMsg, setMissedDaysMsg] = useState(null);
            const [pomoState, setPomoState] = useState({ active: false, type: 'work', currentCycle: 1, totalCycles: 1, workDur: 25, breakDur: 5 });
            const [timer, setTimer] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [activeTask, setActiveTask] = useState(null);
            const [pendingTask, setPendingTask] = useState(null);
            const [showPhoneCheck, setShowPhoneCheck] = useState(false);
            const [syncStatus, setSyncStatus] = useState("OFFLINE");
            const [isSyncing, setIsSyncing] = useState(false);
            
            const { isNoiseOn, toggleNoise, isTickOn, toggleTick, isBlueOn, toggleBlue } = AudioEngine();
            const [prevStreak, setPrevStreak] = useState(0);
            const [prevStartDate, setPrevStartDate] = useState(null);

            const addDebugLog = (msg) => {
                const time = new Date().toLocaleTimeString();
                setDebugLogs(prev => [{time, msg}, ...prev].slice(0, 50));
            };

            // --- PERSISTENCE ---
            useEffect(() => {
                const loadLocal = () => {
                    try {
                        const sStreak = localStorage.getItem('s22_streak');
                        const sCheck = localStorage.getItem('s22_lastCheck');
                        const sPatterns = localStorage.getItem('s22_patterns');
                        const sStart = localStorage.getItem('s22_startDate');
                        const sRules = localStorage.getItem('s22_rules');
                        const sTasks = localStorage.getItem('s22_tasks');
                        const sArchive = localStorage.getItem('s22_archive');
                        const sCloud = localStorage.getItem('s22_cloudConfig');
                        
                        if(sStreak) setStreak(parseInt(sStreak));
                        if(sCheck) setLastCheckIn(sCheck);
                        if(sPatterns) setPatterns(JSON.parse(sPatterns));
                        if(sStart) setStartDate(sStart);
                        if(sRules) setCustomRules(JSON.parse(sRules));
                        if(sTasks) setTasks(JSON.parse(sTasks));
                        if(sArchive) setTaskArchive(JSON.parse(sArchive));
                        if(sCloud) setCloudConfig(JSON.parse(sCloud));

                        if (sCheck && sStreak > 0) {
                            const lastDate = new Date(sCheck); const today = new Date(); lastDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
                            const diffTime = Math.abs(today - lastDate); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                            if (diffDays > 1) setMissedDaysMsg(`ÿ∫Ÿäÿßÿ® ${diffDays - 1} ŸäŸàŸÖ.`);
                        }
                    } catch (e) {
                        console.error("Local load error", e);
                        addDebugLog("Local storage corruption detected.");
                    }
                };
                loadLocal();
            }, []);

            useEffect(() => { localStorage.setItem('s22_patterns', JSON.stringify(patterns)); }, [patterns]);
            useEffect(() => { localStorage.setItem('s22_streak', streak); }, [streak]);
            useEffect(() => { localStorage.setItem('s22_lastCheck', lastCheckIn); }, [lastCheckIn]);
            useEffect(() => { if (startDate) localStorage.setItem('s22_startDate', startDate); else localStorage.removeItem('s22_startDate'); }, [startDate]);
            useEffect(() => { localStorage.setItem('s22_rules', JSON.stringify(customRules)); }, [customRules]);
            useEffect(() => { localStorage.setItem('s22_tasks', JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { localStorage.setItem('s22_archive', JSON.stringify(taskArchive)); }, [taskArchive]);
            useEffect(() => localStorage.setItem('s22_cloudConfig', JSON.stringify(cloudConfig)), [cloudConfig]);

            // --- INITIALIZE CLOUD AND AUTO DOWNLOAD ---
            useEffect(() => {
                if (!cloudConfig.apiKey || !cloudConfig.projectId || !cloudConfig.secretId) return;

                const connectAndAutoPull = async () => {
                    const appConfig = { apiKey: cloudConfig.apiKey, projectId: cloudConfig.projectId };
                    
                    try {
                        // 1. Initialize Firebase
                        let db;
                        try {
                            const app = window.firebaseModules.initializeApp(appConfig);
                            db = window.firebaseModules.getFirestore();
                            addDebugLog("Cloud initialized.");
                        } catch (initError) {
                            if (initError.code === 'app/duplicate-app') {
                                db = window.firebaseModules.getFirestore();
                                addDebugLog("Cloud connection restored.");
                            } else {
                                throw initError;
                            }
                        }

                        // 2. AUTO PULL (DOWNLOAD) LOGIC
                        const docRef = window.firebaseModules.doc(db, "systems", cloudConfig.secretId);
                        const docSnap = await window.firebaseModules.getDoc(docRef);
                        
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            addDebugLog("Data found in cloud. Auto-restoring...");
                            
                            // Apply data directly to state
                            if(data.streak !== undefined) setStreak(data.streak);
                            if(data.patterns) setPatterns(JSON.parse(data.patterns));
                            if(data.tasks) setTasks(JSON.parse(data.tasks));
                            if(data.archive) setTaskArchive(JSON.parse(data.archive));
                            if(data.rules) setCustomRules(JSON.parse(data.rules));
                            if(data.lastCheckIn) setLastCheckIn(data.lastCheckIn);
                            if(data.startDate) setStartDate(data.startDate);
                            
                            setSyncStatus("AUTO-SYNCED");
                            setUnsavedChanges(false);
                            addDebugLog("Auto-Restore successful.");
                        } else {
                            setSyncStatus("CONNECTED (NEW)");
                            addDebugLog("Cloud initialized. No existing data found (New System).");
                        }

                    } catch (e) {
                        console.error("Cloud Init/Pull Error", e);
                        setSyncStatus("ERROR");
                        addDebugLog(`Error: ${e.message}`);
                    }
                };
                
                connectAndAutoPull();
            }, [cloudConfig.apiKey, cloudConfig.projectId, cloudConfig.secretId]);

            // --- MANUAL PUSH (UPLOAD) ---
            const manualPush = async () => {
                if (syncStatus.includes("ERROR") || !cloudConfig.secretId || !window.firebaseModules) {
                    alert("CLOUD NOT CONNECTED");
                    return;
                }

                // VALIDATION: Check if system is completely empty
                const isEmpty = streak === 0 && tasks.length === 0 && patterns.length === 0 && taskArchive.length === 0;
                if (isEmpty) {
                    alert("CRITICAL WARNING: SYSTEM EMPTY.\n\nNothing to upload. Uploading blank data will wipe your cloud history.\nAction Aborted.");
                    return;
                }

                setIsSyncing(true);
                try {
                    const db = window.firebaseModules.getFirestore();
                    const docRef = window.firebaseModules.doc(db, "systems", cloudConfig.secretId);
                    
                    const payload = {
                        streak,
                        patterns: JSON.stringify(patterns),
                        tasks: JSON.stringify(tasks),
                        archive: JSON.stringify(taskArchive),
                        rules: JSON.stringify(customRules),
                        lastCheckIn,
                        startDate,
                        lastUpdate: new Date().toISOString()
                    };

                    await window.firebaseModules.setDoc(docRef, payload);
                    setSyncStatus("UPLOADED");
                    setUnsavedChanges(false);
                    addDebugLog("Manual Upload Successful.");
                } catch (e) {
                    console.error("Upload failed", e);
                    setSyncStatus("UPLOAD FAIL");
                    addDebugLog(`Upload Fail: ${e.message}`);
                    alert("FAILED TO UPLOAD. CHECK PERMISSIONS.");
                } finally {
                    setIsSyncing(false);
                }
            };

            // --- MANUAL PULL (DOWNLOAD) ---
            const manualPull = async () => {
                if (syncStatus.includes("ERROR") || !cloudConfig.secretId || !window.firebaseModules) {
                     alert("CLOUD NOT CONNECTED");
                     return;
                }
                
                if(!confirm("‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: Ÿáÿ∞ÿß ÿ≥ŸäŸÇŸàŸÖ ÿ®ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü")) return;

                setIsSyncing(true);
                try {
                    const db = window.firebaseModules.getFirestore();
                    const docRef = window.firebaseModules.doc(db, "systems", cloudConfig.secretId);
                    
                    const docSnap = await window.firebaseModules.getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        addDebugLog("Downloading data manually...");
                        
                        if(data.streak !== undefined) setStreak(data.streak);
                        if(data.patterns) setPatterns(JSON.parse(data.patterns));
                        if(data.tasks) setTasks(JSON.parse(data.tasks));
                        if(data.archive) setTaskArchive(JSON.parse(data.archive));
                        if(data.rules) setCustomRules(JSON.parse(data.rules));
                        if(data.lastCheckIn) setLastCheckIn(data.lastCheckIn);
                        if(data.startDate) setStartDate(data.startDate);
                        
                        setSyncStatus("DOWNLOADED");
                        setUnsavedChanges(false);
                        addDebugLog("Manual Download Successful.");
                    } else {
                        alert("NO DATA FOUND ON CLOUD.");
                        addDebugLog("Doc not found.");
                    }
                } catch (e) {
                    console.error("Download failed", e);
                    setSyncStatus("DOWNLOAD FAIL");
                    addDebugLog(`Download Fail: ${e.message}`);
                } finally {
                    setIsSyncing(false);
                }
            };

            const markLocalChange = () => { setUnsavedChanges(true); };

            const handleCheckIn = (success) => {
                const today = new Date().toDateString();
                if (lastCheckIn === today) return;
                setPrevStreak(streak); setPrevStartDate(startDate); 
                markLocalChange();
                if (success) { if (streak === 0) setStartDate(new Date().toISOString()); setStreak(s => s + 1); setLastCheckIn(today); setMissedDaysMsg(null); } 
                else { addLog("ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿ®ÿ±Ÿàÿ™ŸàŸÉŸàŸÑ ÿßŸÑÿ™ÿ∑ŸáŸäÿ± (Manual Reset).", "failure"); setStreak(0); setStartDate(null); setLastCheckIn(today); }
            };
            const handleUndoCheckIn = () => { 
                markLocalChange();
                setStreak(prevStreak); setStartDate(prevStartDate); setLastCheckIn(null); alert("ÿ™ŸÖ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ."); 
            };
            
            const addLog = (text, type) => { 
                markLocalChange();
                setPatterns(prev => [{ id: Date.now(), date: new Date().toLocaleString('ar-MA'), text, type }, ...prev]); 
            };
            const deleteLog = (id) => { 
                if(confirm("DELETE THIS INTEL?")) {
                    markLocalChange();
                    setPatterns(prev => prev.filter(p => p.id !== id)); 
                }
            };
            const updateLog = (id, newText) => { 
                markLocalChange();
                setPatterns(prev => prev.map(p => p.id === id ? { ...p, text: newText } : p)); 
            };
            
            const addRule = (title, text) => { 
                markLocalChange();
                setCustomRules(prev => [...prev, { id: Date.now(), title, text }]); 
            };
            const deleteRule = (id) => { 
                if(confirm("DELETE THIS RULE?")) { 
                    markLocalChange();
                    setCustomRules(prev => prev.filter(r => r.id !== id)); 
                } 
            };
            const updateRule = (id, title, text) => { 
                markLocalChange();
                setCustomRules(prev => prev.map(r => r.id === id ? { ...r, title, text } : r)); 
            };
            
            const addTask = (task) => { 
                markLocalChange();
                setTasks(prev => [task, ...prev]); 
            };
            
            const deleteDirect = (type, id) => {
                if(confirm("PERMANENTLY DELETE THIS ITEM?")) {
                    markLocalChange();
                    if (type === 'task') setTasks(prev => prev.filter(t => t.id !== id));
                    if (type === 'archive') setTaskArchive(prev => prev.filter(t => t.id !== id));
                }
            };
            
            const initiateTaskSequence = (task) => { setPendingTask(task); setShowPhoneCheck(true); };
            
            const confirmPhoneCheck = () => { 
                setShowPhoneCheck(false); 
                // --- AUTO FULLSCREEN ---
                try {
                    const docElm = document.documentElement;
                    if (docElm.requestFullscreen) {
                        docElm.requestFullscreen();
                    }
                } catch (e) { console.log("Fullscreen blocked or not supported"); }
                
                if (pendingTask) { 
                    setActiveTask(pendingTask); 
                    startPomoSequence(pendingTask.work, pendingTask.break, pendingTask.cycles); 
                    playAlert('work'); 
                    setView('deepwork'); 
                } 
            };

            const cancelTask = () => { if(confirm("ABORT OPERATION?")) { setIsTimerRunning(false); setActiveTask(null); setPomoState({ ...pomoState, active: false }); setTimer(0); } };
            const startPomoSequence = (workDur, breakDur, cycles) => { setPomoState({ active: true, type: 'work', currentCycle: 1, totalCycles: cycles, workDur, breakDur }); setTimer(workDur * 60); setIsTimerRunning(true); };
            const formatTime = (sec) => { const m = Math.floor(sec / 60); const s = sec % 60; return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; };
            
            const saveCloudConfig = (config) => { 
                setCloudConfig(config); 
                setSyncStatus("CONNECTING...");
            };

            const disconnect = () => {
                if(confirm("Disconnect from Cloud?")) {
                    setCloudConfig({ apiKey: "", projectId: "", secretId: "" });
                    setSyncStatus("OFFLINE");
                    addDebugLog("Disconnected manually.");
                }
            };

            // Timer Tick Effect
            useEffect(() => {
                let interval = null;
                if (isTimerRunning && timer > 0) { 
                    interval = setInterval(() => setTimer(t => t - 1), 1000); 
                } else if (timer === 0 && isTimerRunning) {
                    if (pomoState.active) {
                        if (pomoState.type === 'work') {
                             playAlert('break'); 
                             if (isNoiseOn) toggleNoise(); if (isTickOn) toggleTick(); if (isBlueOn) toggleBlue(); 

                            if (pomoState.currentCycle < pomoState.totalCycles) { 
                                setPomoState(prev => ({ ...prev, type: 'break' })); 
                                setTimer(pomoState.breakDur * 60); 
                            } else { 
                                setIsTimerRunning(false); 
                                setPomoState(prev => ({ ...prev, active: false })); 
                                playAlert('victory');
                                if (activeTask) {
                                    markLocalChange();
                                    addLog(`MISSION ACCOMPLISHED: ${activeTask.title}`, "intel");
                                    setTaskArchive(prev => [{...activeTask, completedAt: new Date().toLocaleDateString('ar-MA')}, ...prev]);
                                    setTasks(prev => prev.filter(t => t.id !== activeTask.id));
                                    setActiveTask(null);
                                    alert(`MISSION COMPLETED: ${activeTask.title}`);
                                }
                            }
                        } else {
                            playAlert('work'); 
                            setPomoState(prev => ({ ...prev, type: 'work', currentCycle: prev.currentCycle + 1 })); 
                            setTimer(pomoState.workDur * 60);
                        }
                    } else { 
                        playAlert('work'); setIsTimerRunning(false); 
                        if (isNoiseOn) toggleNoise(); if (isTickOn) toggleTick(); if (isBlueOn) toggleBlue(); 
                    }
                }
                return () => clearInterval(interval);
            }, [isTimerRunning, timer, pomoState, activeTask, isNoiseOn, isTickOn, isBlueOn, toggleNoise, toggleTick, toggleBlue]);

            return (
                <div className="flex flex-col md:flex-row h-screen w-full bg-void-bg text-gray-200 overflow-hidden relative selection:bg-cold-blue selection:text-black">
                    <div className="scanline-bar"></div><div className="crt-overlay"></div><div className="absolute inset-0 bg-grid-pattern opacity-10 pointer-events-none"></div>
                    {showPhoneCheck && (
                        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="glass-panel p-8 max-w-sm w-full text-center border-danger-red animate-pulse">
                                <div className="text-4xl mb-4">üö´üì±</div>
                                <h3 className="text-xl font-bold text-white mb-2">FINAL SECURITY CHECK</h3>
                                <p className="text-sm text-gray-400 mb-6">ŸáŸÑ ÿßŸÑŸáÿßÿ™ŸÅ ŸÅŸä ÿ∫ÿ±ŸÅÿ© ÿ£ÿÆÿ±Ÿâÿü<br/>ŸÑÿß ÿ™ÿ®ÿØÿ£ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÇÿ®ŸÑ ÿ™ÿ£ŸÖŸäŸÜ ÿßŸÑŸÖÿ≠Ÿäÿ∑.</p>
                                <div className="flex gap-4">
                                    <button onClick={confirmPhoneCheck} className="flex-1 py-3 bg-danger-red text-black font-bold">YES, SECURE</button>
                                    <button onClick={() => setShowPhoneCheck(false)} className="flex-1 py-3 border border-white/20">CANCEL</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="hidden md:block h-full z-20"><Sidebar view={view} setView={setView} unsavedChanges={unsavedChanges} /></div>
                    <main className="flex-1 h-full overflow-y-auto overflow-x-hidden relative p-4 md:p-8 z-10 custom-scrollbar">
                        {view === 'dashboard' && <Dashboard streak={streak} handleCheckIn={handleCheckIn} handleUndoCheckIn={handleUndoCheckIn} lastCheckIn={lastCheckIn} startDate={startDate} missedDaysMsg={missedDaysMsg} patterns={patterns} customRules={customRules} />}
                        {view === 'tasks' && <><TaskManager tasks={tasks} addTask={addTask} deleteDirect={deleteDirect} startTaskExecution={initiateTaskSequence} /><SuccessArchive archive={taskArchive} deleteDirect={deleteDirect} /></>}
                        {view === 'deepwork' && <DeepWork activeTask={activeTask} pomoState={pomoState} setPomoState={setPomoState} timer={timer} isTimerRunning={isTimerRunning} startPomoSequence={startPomoSequence} formatTime={formatTime} toggleNoise={toggleNoise} isNoiseOn={isNoiseOn} toggleTick={toggleTick} isTickOn={isTickOn} toggleBlue={toggleBlue} isBlueOn={isBlueOn} cancelTask={cancelTask} />}
                        {view === 'heatmap' && <HeatmapLogs patterns={patterns} addLog={addLog} deleteLog={deleteLog} updateLog={updateLog} />}
                        {view === 'protocol' && <Protocol customRules={customRules} addRule={addRule} deleteRule={deleteRule} updateRule={updateRule} />}
                        {view === 'cloud' && <CloudSettings cloudConfig={cloudConfig} saveCloudConfig={saveCloudConfig} syncStatus={syncStatus} isSyncing={isSyncing} debugLogs={debugLogs} disconnect={disconnect} manualPush={manualPush} manualPull={manualPull} unsavedChanges={unsavedChanges} streak={streak} tasks={tasks} patterns={patterns} taskArchive={taskArchive} />}
                    </main>
                    <div className="md:hidden z-50"><MobileNav view={view} setView={setView} /></div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<System22Desktop />);
    </script>
</body>
</html>
